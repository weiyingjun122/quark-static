<!DOCTYPE html>
<html>
<head>
    <title>Worker ç»Ÿè®¡æµ‹è¯•ï¼ˆå¢å¼ºç‰ˆï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>ğŸ“± Worker ç»Ÿè®¡æµ‹è¯•ï¼ˆæ‰‹æœºä¸“ç”¨ï¼‰</h1>

    <div>
        <button class="button" onclick="testWithFetch()">ä½¿ç”¨ Fetch æµ‹è¯•</button>
        <button class="button" onclick="testWithXHR()">ä½¿ç”¨ XHR æµ‹è¯•</button>
        <button class="button" onclick="testWithBeacon()">ä½¿ç”¨ sendBeacon æµ‹è¯•</button>
        <button class="button" onclick="testWithJSONP()">ä½¿ç”¨ JSONP æµ‹è¯•</button>
        <button class="button" onclick="testWithImage()">ä½¿ç”¨ Image Ping æµ‹è¯•</button>
        <button class="button" onclick="openDirectLink()">ç›´æ¥æ‰“å¼€é“¾æ¥</button>
    </div>

    <div>
        <h3>è®¾å¤‡ä¿¡æ¯</h3>
        <div id="deviceInfo"></div>
    </div>

    <div>
        <h3>ç½‘ç»œè¯Šæ–­</h3>
        <button class="button" onclick="testNetwork()">æµ‹è¯•ç½‘ç»œè¿é€šæ€§</button>
        <button class="button" onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
        <div id="networkStatus"></div>
    </div>

    <div>
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        const WORKER_URL = 'https://quark-search-api.weiyingjun122.workers.dev';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : '';

            const logItem = document.createElement('div');
            logItem.className = color;
            logItem.innerHTML = `<strong>[${time}] ${prefix}</strong> ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;

            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        function showDeviceInfo() {
            const deviceInfo = document.getElementById('deviceInfo');
            const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);

            deviceInfo.innerHTML = `
                <p><strong>è®¾å¤‡ç±»å‹:</strong> ${isMobile ? 'ğŸ“± æ‰‹æœº' : 'ğŸ’» ç”µè„‘'}</p>
                <p><strong>æµè§ˆå™¨:</strong> ${navigator.userAgent}</p>
                <p><strong>åœ¨çº¿çŠ¶æ€:</strong> ${navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}</p>
                <p><strong>è¯­è¨€:</strong> ${navigator.language}</p>
                <p><strong>å¹³å°:</strong> ${navigator.platform}</p>
                <p><strong>Worker URL:</strong> ${WORKER_URL}</p>
            `;

            log(`è®¾å¤‡ç±»å‹: ${isMobile ? 'æ‰‹æœº' : 'ç”µè„‘'}`);
            log(`æµè§ˆå™¨: ${navigator.userAgent.split(' ').pop()}`);
            log(`åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
        }

        // æ–¹æ³•1: ä½¿ç”¨ Fetch APIï¼ˆæ ‡å‡†æ–¹æ³•ï¼‰
        async function testWithFetch() {
            const keyword = 'fetchæµ‹è¯•_' + Date.now();
            log(`ğŸ“¤ ä½¿ç”¨ Fetch å‘é€: "${keyword}"`);

            try {
                const startTime = Date.now();
                const response = await fetch(`${WORKER_URL}/record?q=${encodeURIComponent(keyword)}`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    cache: 'no-store'
                });
                const endTime = Date.now();

                log(`ğŸ“¥ å“åº”æ—¶é—´: ${endTime - startTime}ms`);
                log(`ğŸ“¥ çŠ¶æ€ç : ${response.status} ${response.statusText}`);
                log(`ğŸ“¥ å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers))}`);

                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Fetch æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                } else {
                    const text = await response.text();
                    log(`âŒ Fetch å¤±è´¥: ${text}`, 'error');
                }
            } catch (error) {
                log(`âŒ Fetch é”™è¯¯: ${error.message}`, 'error');
                log(`ğŸ“‹ é”™è¯¯è¯¦æƒ…: ${error.stack}`, 'error');
            }
        }

        // æ–¹æ³•2: ä½¿ç”¨ XMLHttpRequestï¼ˆè€å¼æ–¹æ³•ï¼‰
        function testWithXHR() {
            const keyword = 'xhræµ‹è¯•_' + Date.now();
            log(`ğŸ“¤ ä½¿ç”¨ XHR å‘é€: "${keyword}"`);

            const xhr = new XMLHttpRequest();
            const url = `${WORKER_URL}/record?q=${encodeURIComponent(keyword)}`;

            xhr.open('GET', url, true);
            xhr.timeout = 10000; // 10ç§’è¶…æ—¶

            xhr.onload = function() {
                log(`ğŸ“¥ XHR çŠ¶æ€: ${xhr.status} ${xhr.statusText}`);
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        log(`âœ… XHR æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                    } catch (e) {
                        log(`âŒ XHR è§£æå¤±è´¥: ${e.message}`, 'error');
                    }
                } else {
                    log(`âŒ XHR å¤±è´¥: ${xhr.statusText}`, 'error');
                }
            };

            xhr.onerror = function() {
                log(`âŒ XHR ç½‘ç»œé”™è¯¯`, 'error');
            };

            xhr.ontimeout = function() {
                log(`âŒ XHR è¯·æ±‚è¶…æ—¶`, 'error');
            };

            xhr.send();
        }

        // æ–¹æ³•3: ä½¿ç”¨ sendBeaconï¼ˆæœ€å¯é ï¼Œä½†åªèƒ½å‘é€å°‘é‡æ•°æ®ï¼‰
        function testWithBeacon() {
            const keyword = 'beaconæµ‹è¯•_' + Date.now();
            log(`ğŸ“¤ ä½¿ç”¨ sendBeacon å‘é€: "${keyword}"`);

            const data = new URLSearchParams();
            data.append('q', keyword);

            const blob = new Blob([data.toString()], {type: 'application/x-www-form-urlencoded'});
            const success = navigator.sendBeacon(`${WORKER_URL}/record`, blob);

            if (success) {
                log(`âœ… sendBeacon å‘é€æˆåŠŸ`, 'success');
            } else {
                log(`âŒ sendBeacon å‘é€å¤±è´¥`, 'error');
            }
        }

        // æ–¹æ³•4: ä½¿ç”¨ JSONPï¼ˆç»•è¿‡ CORSï¼‰
        function testWithJSONP() {
            const keyword = 'jsonpæµ‹è¯•_' + Date.now();
            log(`ğŸ“¤ ä½¿ç”¨ JSONP å‘é€: "${keyword}"`);

            const callbackName = 'jsonp_callback_' + Date.now();
            const script = document.createElement('script');

            window[callbackName] = function(data) {
                log(`âœ… JSONP æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                delete window[callbackName];
                document.body.removeChild(script);
            };

            script.src = `${WORKER_URL}/record?q=${encodeURIComponent(keyword)}&callback=${callbackName}`;
            script.onerror = function() {
                log(`âŒ JSONP åŠ è½½å¤±è´¥`, 'error');
                delete window[callbackName];
                document.body.removeChild(script);
            };

            document.body.appendChild(script);
        }

        // æ–¹æ³•5: ä½¿ç”¨ Image Pingï¼ˆæœ€ç®€å•ï¼‰
        function testWithImage() {
            const keyword = 'imageæµ‹è¯•_' + Date.now();
            log(`ğŸ“¤ ä½¿ç”¨ Image Ping å‘é€: "${keyword}"`);

            const img = new Image();
            img.src = `${WORKER_URL}/record?q=${encodeURIComponent(keyword)}&_ping=1&_=${Date.now()}`;

            img.onload = function() {
                log(`âœ… Image Ping æˆåŠŸ`, 'success');
            };

            img.onerror = function() {
                log(`âŒ Image Ping å¤±è´¥`, 'error');
            };
        }

        // æ–¹æ³•6: ç›´æ¥æ‰“å¼€é“¾æ¥ï¼ˆç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ï¼‰
        function openDirectLink() {
            const keyword = 'directæµ‹è¯•_' + new Date().toLocaleTimeString();
            const url = `${WORKER_URL}/record?q=${encodeURIComponent(keyword)}`;

            log(`ğŸ”— æ‰“å¼€é“¾æ¥: ${url}`);

            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
            window.open(url, '_blank');

            // åŒæ—¶åœ¨åå°æµ‹è¯•
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    log(`âœ… åå°æµ‹è¯•æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                })
                .catch(e => {
                    log(`âŒ åå°æµ‹è¯•å¤±è´¥: ${e.message}`, 'error');
                });
        }

        // ç½‘ç»œè¯Šæ–­
        async function testNetwork() {
            log('ğŸ” å¼€å§‹ç½‘ç»œè¯Šæ–­...');

            // æµ‹è¯• DNS è§£æ
            try {
                await fetch('https://dns.google/resolve?name=quark-search-api.weiyingjun122.workers.dev&type=A', {
                    mode: 'no-cors'
                });
                log('âœ… DNS è§£ææ­£å¸¸', 'success');
            } catch (e) {
                log(`âŒ DNS è§£æå¯èƒ½æœ‰é—®é¢˜`, 'warning');
            }

            // æµ‹è¯• Worker æ ¹è·¯å¾„
            try {
                const response = await fetch(WORKER_URL, { mode: 'no-cors' });
                log('âœ… Worker æ ¹è·¯å¾„å¯è®¿é—®', 'success');
            } catch (e) {
                log(`âŒ Worker æ ¹è·¯å¾„æ— æ³•è®¿é—®`, 'error');
            }

            // æµ‹è¯•å…¶ä»– CDNï¼ˆå¯¹æ¯”ï¼‰
            try {
                await fetch('https://httpbin.org/get', { mode: 'no-cors' });
                log('âœ… å¤–éƒ¨ç½‘ç»œæ­£å¸¸', 'success');
            } catch (e) {
                log(`âŒ å¤–éƒ¨ç½‘ç»œå¯èƒ½æœ‰é—®é¢˜`, 'warning');
            }
        }

        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(function(cacheNames) {
                    cacheNames.forEach(function(cacheName) {
                        caches.delete(cacheName);
                    });
                    log('âœ… ç¼“å­˜å·²æ¸…é™¤', 'success');
                });
            } else {
                log('â„¹ï¸ æµè§ˆå™¨ä¸æ”¯æŒ Cache API');
            }

            // æ¸…é™¤ localStorage
            try {
                localStorage.clear();
                sessionStorage.clear();
                log('âœ… Storage å·²æ¸…é™¤', 'success');
            } catch (e) {
                log(`â„¹ï¸ Storage æ¸…é™¤å¤±è´¥: ${e.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            showDeviceInfo();
            log('ğŸŸ¢ æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ğŸ“± è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯•ä¸åŒæ–¹æ³•');

            // è‡ªåŠ¨è¿è¡Œä¸€ä¸ªç®€å•æµ‹è¯•
            setTimeout(() => {
                log('âš¡ è‡ªåŠ¨è¿è¡Œå¿«é€Ÿæµ‹è¯•...');
                testWithImage(); // ç”¨æœ€ç®€å•çš„æ–¹æ³•å…ˆè¯•
            }, 1000);
        };

        // ç›‘å¬ç½‘ç»œçŠ¶æ€
        window.addEventListener('online', () => {
            log('ğŸŒ ç½‘ç»œå·²è¿æ¥', 'success');
        });

        window.addEventListener('offline', () => {
            log('ğŸŒ ç½‘ç»œå·²æ–­å¼€', 'error');
        });
    </script>
</body>
</html>
