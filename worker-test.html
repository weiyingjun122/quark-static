<!DOCTYPE html>
<html>
<head>
    <title>Worker ç»Ÿè®¡æµ‹è¯•</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>ğŸ“± Worker ç»Ÿè®¡æµ‹è¯•</h1>

    <div>
        <p><strong>Worker URL:</strong> https://quark-search-api.weiyingjun122.workers.dev</p>
        <p><strong>æµ‹è¯•æ–¹æ³•:</strong> ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•å„ä¸ªæ¥å£</p>
    </div>

    <div style="margin: 20px 0;">
        <button onclick="testDirectRecord()">ğŸ”— ç›´æ¥æµ‹è¯• /record æ¥å£</button>
        <button onclick="testRecord()">ğŸ“ æµ‹è¯•è®°å½•æœç´¢</button>
        <button onclick="testHot()">ğŸ”¥ æµ‹è¯•è·å–çƒ­æœ</button>
        <button onclick="testDebug()">ğŸ› æµ‹è¯•è°ƒè¯•æ¥å£</button>
        <button onclick="testAll()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    </div>

    <div>
        <h3>ğŸ“‹ è®¾å¤‡ä¿¡æ¯</h3>
        <div id="deviceInfo"></div>
    </div>

    <div>
        <h3>ğŸ“œ æµ‹è¯•ç»“æœ</h3>
        <div id="result" style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 10px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        const WORKER_URL = 'https://quark-search-api.weiyingjun122.workers.dev';

        function log(msg, type = 'info') {
            const resultDiv = document.getElementById('result');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';

            const logItem = document.createElement('div');
            logItem.style.margin = '5px 0';
            logItem.style.padding = '5px';
            logItem.style.borderLeft = `3px solid ${color}`;
            logItem.style.backgroundColor = '#fff';
            logItem.innerHTML = `<strong>${prefix}</strong> ${msg}`;

            resultDiv.appendChild(logItem);
            resultDiv.scrollTop = resultDiv.scrollHeight;
            console.log(`${prefix} ${msg}`);
        }

        // ç›´æ¥æµ‹è¯•æ¥å£ï¼ˆä¸ç”¨ fetchï¼Œç›´æ¥è®¿é—®ï¼‰
        function testDirectRecord() {
            const keyword = 'ç›´æ¥æµ‹è¯•_' + new Date().toLocaleTimeString();
            const url = `${WORKER_URL}/record?q=${encodeURIComponent(keyword)}`;

            log(`æ‰“å¼€æ–°çª—å£è®¿é—®: ${url}`);

            // æ–¹æ³•1ï¼šç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€
            window.open(url, '_blank');

            // æ–¹æ³•2ï¼šä½¿ç”¨ iframeï¼ˆæ›´å‹å¥½ï¼‰
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            // æ–¹æ³•3ï¼šä½¿ç”¨ fetch æµ‹è¯•
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    log(`âœ… ç›´æ¥æµ‹è¯•æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                })
                .catch(e => {
                    log(`âŒ ç›´æ¥æµ‹è¯•å¤±è´¥: ${e.message}`, 'error');
                });
        }

        function testRecord() {
            const keyword = 'æ‰‹æœºæµ‹è¯•_' + Date.now();
            log(`ğŸ“± æµ‹è¯•æœç´¢: "${keyword}"`);

            fetch(`${WORKER_URL}/record?q=${encodeURIComponent(keyword)}`)
                .then(r => {
                    log(`HTTP çŠ¶æ€: ${r.status} ${r.statusText}`);
                    return r.json();
                })
                .then(data => log(`âœ… æˆåŠŸ: ${JSON.stringify(data)}`, 'success'))
                .catch(e => log(`âŒ å¤±è´¥: ${e.message}`, 'error'));
        }

        function testHot() {
            log('ğŸ”¥ è·å–çƒ­æœ...');

            fetch(`${WORKER_URL}/hot`)
                .then(r => r.json())
                .then(data => {
                    if (Array.isArray(data) && data.length > 0) {
                        log(`âœ… è·å–åˆ° ${data.length} ä¸ªçƒ­æœ`, 'success');
                        data.forEach(item => {
                            log(`   "${item.word}": ${item.count}æ¬¡`);
                        });
                    } else {
                        log('â„¹ï¸ æš‚æ— è¾¾åˆ°é˜ˆå€¼(â‰¥10æ¬¡)çš„çƒ­æœè¯');
                    }
                })
                .catch(e => log(`âŒ å¤±è´¥: ${e.message}`, 'error'));
        }

        function testDebug() {
            log('ğŸ› è·å–è°ƒè¯•ä¿¡æ¯...');

            fetch(`${WORKER_URL}/debug`)
                .then(r => r.json())
                .then(data => {
                    if (data.statsSummary) {
                        const s = data.statsSummary;
                        log(`âœ… æ€»å…³é”®è¯: ${s.totalKeywords}`, 'success');
                        log(`âœ… æ€»æœç´¢æ¬¡æ•°: ${s.totalSearches}`, 'success');
                        log(`âœ… è¾¾åˆ°é˜ˆå€¼(â‰¥10): ${s.keywordsAboveThreshold}`, 'success');

                        if (s.top10Keywords && s.top10Keywords.length > 0) {
                            log('ğŸ“Š çƒ­é—¨å…³é”®è¯:');
                            s.top10Keywords.forEach(item => {
                                log(`   "${item.word}": ${item.count}æ¬¡`);
                            });
                        }
                    } else {
                        log('âŒ æœªæ‰¾åˆ°ç»Ÿè®¡æ•°æ®');
                    }
                })
                .catch(e => log(`âŒ å¤±è´¥: ${e.message}`, 'error'));
        }

        function testAll() {
            log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...');
            testRecord();
            setTimeout(testDebug, 1000);
            setTimeout(testHot, 2000);
        }

        // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        function showDeviceInfo() {
            const deviceInfo = document.getElementById('deviceInfo');
            const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);

            deviceInfo.innerHTML = `
                <p><strong>è®¾å¤‡ç±»å‹:</strong> ${isMobile ? 'ğŸ“± æ‰‹æœº' : 'ğŸ’» ç”µè„‘'}</p>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>åœ¨çº¿çŠ¶æ€:</strong> ${navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}</p>
                <p><strong>è¯­è¨€:</strong> ${navigator.language}</p>
                <p><strong>Worker URL:</strong> ${WORKER_URL}</p>
                <p><strong>æµ‹è¯•é¡µé¢ URL:</strong> ${window.location.href}</p>
            `;

            log(`è®¾å¤‡: ${navigator.userAgent}`);
            log(`æ˜¯å¦ä¸ºæ‰‹æœº: ${isMobile ? 'æ˜¯' : 'å¦'}`);
            log(`åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            showDeviceInfo();
            log('ğŸŸ¢ æµ‹è¯•é¡µé¢å·²åŠ è½½å®Œæˆ');
            log(`ğŸ“± è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•`);

            // è‡ªåŠ¨è¿è¡Œä¸€æ¬¡å¿«é€Ÿæµ‹è¯•
            setTimeout(() => {
                log('âš¡ è‡ªåŠ¨è¿è¡Œå¿«é€Ÿæµ‹è¯•...');
                testRecord();
            }, 1000);
        };

        // ç›‘å¬ç½‘ç»œçŠ¶æ€
        window.addEventListener('online', () => {
            log('ğŸŒ ç½‘ç»œå·²è¿æ¥', 'success');
        });

        window.addEventListener('offline', () => {
            log('ğŸŒ ç½‘ç»œå·²æ–­å¼€', 'error');
        });
    </script>
</body>
</html>
