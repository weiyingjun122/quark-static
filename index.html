<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤¸å…‹ç½‘ç›˜èµ„æºæœç´¢ - å…è´¹é«˜é€Ÿä¸‹è½½</title>
<meta name="description" content="æä¾›å¤¸å…‹ç½‘ç›˜èµ„æºæœç´¢æœåŠ¡ï¼Œæ”¯æŒå½±è§†ã€è¯¾ç¨‹ã€ç”µå­ä¹¦ã€å­¦ä¹ èµ„æ–™ç­‰å…³é”®è¯å¿«é€ŸæŸ¥æ‰¾ï¼Œæ— éœ€æ³¨å†Œï¼Œä¸€é”®è·³è½¬å¤¸å…‹APPä¿å­˜èµ„æºï¼Œæ–¹ä¾¿é«˜æ•ˆã€‚">
<style>
body { font-family: "Microsoft YaHei", Arial, sans-serif; background: #f5f5f5; display: flex; flex-direction: column; align-items: center; padding-top: 50px; margin:0; }

/* logo */
.logo { text-align: center; margin-bottom: 40px; flex-shrink: 0; }
.logo img { max-width: 150px; height: auto; display: block; margin: 0 auto; }
.logo h1 { margin-top: 10px; font-size: 28px; color: #333; }

/* æœç´¢æ¡† */
.search-container { display: flex; justify-content: center; margin-bottom: 20px; flex-wrap: nowrap; width: 90%; max-width: 480px; }
.search-container input[type="text"] { flex: 1; padding: 12px; font-size: 16px; border-radius: 5px 0 0 5px; border: 1px solid #ccc; outline: none; }
.search-container button { padding: 12px 24px; font-size: 16px; border-radius: 0 5px 5px 0; border: none; background-color: #1e90ff; color: white; cursor: pointer; transition: background 0.3s; }
.search-container button:hover { background-color: #0f78d1; }

.highlight { color: #e74c3c; font-weight: bold; }

/* æ¨èåŒº */
#recommend { width: 100%; max-width: 480px; margin-bottom: 20px; }
.recommend-card { display: flex; flex-wrap: wrap; gap: 10px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
.recommend-card h3 { width:100%; margin-top:0; margin-bottom:15px; font-size: 16px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 10px;}
.hot-keyword { padding: 6px 12px; background: #f0f6ff; border-radius: 20px; text-align: center; cursor: pointer; transition: all 0.2s; color: #1e90ff; font-size: 14px; }
.hot-keyword:hover { background:#1e90ff; color: #fff; transform: translateY(-2px); }
.hot-fire { color: #ff4500; background: #fff0f0; font-weight: bold; } /* çˆ†æ¬¾æ ·å¼ */

/* æ¨¡æ€æ¡† */
.modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
.modal-content { background-color: #fff; padding: 30px; border-radius: 12px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); position: relative; }
.close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; }
.modal-content img { margin-top: 15px; max-width: 100%; }
.btn { display: inline-block; margin-top: 20px; padding: 12px 35px; font-size: 16px; background-color: #1e90ff; color: #fff; text-decoration: none; border-radius: 25px; cursor:pointer; font-weight: bold; }
.btn:hover { background-color: #0f78d1; }

/* å“åº”å¼ */
@media (max-width: 480px){
    .search-container { flex-wrap: wrap; }
    .search-container input[type="text"] { flex: 1 1 100%; border-radius: 5px; margin-bottom: 8px; }
    .search-container button { flex: 1 1 100%; border-radius: 5px; }
}

/* å…è´£å£°æ˜ */
.site-disclaimer {
    margin: 30px auto;
    padding: 20px;
    max-width: 900px;
    background: #f8f9fa;
    border: 1px solid #eee;
    border-radius: 8px;
    font-size: 12px;
    color: #666;
    text-align: center;
    line-height: 1.6;
}
.site-disclaimer h4 {
    margin-bottom: 10px;
    color: #333;
    font-size: 16px;
}
.site-disclaimer .sub-note {
    font-size: 12px;
    color: #999;
    margin-top: 10px;
}
</style>
</head>
<body>

<!-- logo -->
<div class="logo">
    <img src="static/logo.png" alt="å¤¸å…‹æœç´¢" onerror="this.style.display='none'">
    <h1>å¤¸å…‹ç½‘ç›˜èµ„æºæœç´¢</h1>
</div>

<!-- æœç´¢æ¡† -->
<div class="search-container">
    <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥ç”µå½±ã€ç”µè§†å‰§ã€èµ„æ–™...">
    <button id="searchBtn">æœç´¢</button>
</div>

<!-- é¦–é¡µæ¨èçƒ­æœ -->
<div id="recommend">
    <!-- é»˜è®¤åŠ è½½æ€ï¼ŒJSåŠ è½½å®Œæˆåä¼šè¦†ç›–è¿™é‡Œ -->
    <div class="recommend-card">
        <h3>ğŸ”¥ æ­£åœ¨åŠ è½½å®æ—¶çƒ­æœ...</h3>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>

<script>
// ============================================================
// ğŸ”„ ä¿®æ”¹ä¸ºä½¿ç”¨ Cloudflare Pages Functions API
// æ‰€æœ‰ API è°ƒç”¨ç°åœ¨éƒ½æŒ‡å‘åŒä¸€åŸŸåçš„ /api è·¯å¾„
// ============================================================

// DOM å…ƒç´ 
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const searchBtn = document.getElementById('searchBtn');
const searchInput = document.getElementById('searchInput');

// å…³é—­å¼¹çª—é€»è¾‘
modal.addEventListener('click', e => { if(e.target === modal) modal.style.display='none' });

// åŠ è½½æœ¬åœ°èµ„æºæ•°æ® (data.json ç”± Python è„šæœ¬ç”Ÿæˆ)
let localData = [];
async function loadData() {
    try {
        // Pages ç¯å¢ƒç›´æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„
        const res = await fetch(`data.json?t=${Date.now()}`);
        localData = await res.json();
    } catch {
        console.error("æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥");
        localData = [];
    }
}

// é«˜äº®å…³é”®è¯
function highlight(text, keyword) {
    if(!keyword) return text;
    const reg = new RegExp(`(${keyword})`,'gi');
    return text.replace(reg,'<span class="highlight">$1</span>');
}

// æ ¸å¿ƒæœç´¢åŠŸèƒ½
async function performSearch(keyword) {
    // === ä¸¥æ ¼çš„å‚æ•°éªŒè¯ ===
    console.group('ğŸ” performSearch å‚æ•°éªŒè¯');
    console.log('åŸå§‹å‚æ•°:', keyword);
    console.log('å‚æ•°ç±»å‹:', typeof keyword);

    // æ£€æŸ¥ undefined å’Œ null
    if (keyword === undefined) {
        console.error('âŒ é”™è¯¯ï¼šå‚æ•°æ˜¯ undefined');
        console.trace('è°ƒç”¨å †æ ˆï¼š');
        console.groupEnd();
        return;
    }

    if (keyword === null) {
        console.error('âŒ é”™è¯¯ï¼šå‚æ•°æ˜¯ null');
        console.groupEnd();
        return;
    }

    // è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å»é™¤ç©ºæ ¼
    keyword = String(keyword).trim();
    console.log('è½¬æ¢å:', keyword);
    console.log('é•¿åº¦:', keyword.length);

    // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²
    if (keyword.length === 0) {
        console.error('âŒ é”™è¯¯ï¼šå…³é”®è¯ä¸ºç©ºå­—ç¬¦ä¸²');
        console.groupEnd();
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }

    // æ£€æŸ¥æ˜¯å¦åªæ˜¯ç©ºæ ¼
    if (!keyword.replace(/\s/g, '').length) {
        console.error('âŒ é”™è¯¯ï¼šå…³é”®è¯åªåŒ…å«ç©ºæ ¼');
        console.groupEnd();
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æœç´¢å…³é”®è¯');
        return;
    }

    console.log('âœ… å‚æ•°éªŒè¯é€šè¿‡');
    console.groupEnd();

    // === ç»§ç»­æ‰§è¡Œæ­£å¸¸é€»è¾‘ ===
    // 1. ä¿®æ”¹ URL
    const newUrl = `?q=${encodeURIComponent(keyword)}`;
    window.history.pushState({path:newUrl}, '', newUrl);
    document.title = `${keyword} - å¤¸å…‹èµ„æºæœç´¢`;

    // 2. ä¸ŠæŠ¥ç»Ÿè®¡åˆ° Pages API
    console.log('ğŸ“Š å‘é€ç»Ÿè®¡è¯·æ±‚...');
    try {
        const apiUrl = `/api/record?q=${encodeURIComponent(keyword)}`;
        console.log('è¯·æ±‚URL:', apiUrl);

        const reportRes = await fetch(apiUrl);
        console.log('å“åº”çŠ¶æ€:', reportRes.status);

        if (reportRes.ok) {
            const reportData = await reportRes.json();
            console.log('ç»Ÿè®¡æˆåŠŸ:', reportData);

            if (reportData.count >= 10) {
                loadHotKeywords();
            }
        } else {
            const errorText = await reportRes.text();
            console.warn('ç»Ÿè®¡å¤±è´¥:', reportRes.status, errorText);
        }
    } catch (e) {
        console.warn('ç»Ÿè®¡ä¸ŠæŠ¥å¤±è´¥:', e);
    }

    // 3. åœ¨æœ¬åœ°æ•°æ®ä¸­æŸ¥æ‰¾èµ„æº
    if (localData.length === 0) await loadData();

    // åŒ¹é…é€»è¾‘ï¼šå…ˆæ£€æŸ¥ search_aliasesï¼Œå†æ£€æŸ¥ title å’Œ keywords
    const item = localData.find(d => {
        // å¦‚æœæœ‰ search_aliasesï¼Œç”¨åˆ«ååŒ¹é…ï¼ˆåŒå‘åŒ¹é…ï¼‰
        if (d.search_aliases && d.search_aliases.length > 0) {
            return d.search_aliases.some(alias => 
                keyword.toLowerCase().includes(alias.toLowerCase()) ||
                alias.toLowerCase().includes(keyword.toLowerCase())
            );
        }
        // æ²¡æœ‰åˆ«åæ—¶ï¼Œç”¨ title æˆ– keywords åŒ¹é…
        return d.title.toLowerCase().includes(keyword.toLowerCase()) ||
            (d.keywords && d.keywords.some(k => k.toLowerCase().includes(keyword.toLowerCase())));
    });

    const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
    let html = '';

    if (item) {
        // æ‰¾åˆ°èµ„æº
        html = `<h3>âœ… æ‰¾åˆ°èµ„æºï¼š${highlight(item.title, keyword)}</h3>`;

        if (isMobile) {
            // æ‰‹æœºç«¯ï¼šæ˜¾ç¤ºè·³è½¬æŒ‰é’®
            html += `<p style="color:#666;margin:15px 0;">èµ„æºå·²å‡†å¤‡å¥½ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¿é—®èµ„æº</p>
                     <a href="${item.share_link}" target="_blank" class="btn">æ‰“å¼€å¤¸å…‹APPä¿å­˜</a>`;
        } else {
            // ç”µè„‘ç«¯ï¼šæ˜¾ç¤ºäºŒç»´ç 
            html += `<p style="color:#666;">è¯·ä½¿ç”¨å¤¸å…‹æˆ–å¾®ä¿¡æ‰«æä¸‹æ–¹äºŒç»´ç è®¿é—®èµ„æº</p>
                     <img src="${item.qrcode}" style="width:200px;height:200px;display:block;margin:10px auto;">`;
        }
    } else {
        // æœªæ‰¾åˆ°èµ„æº
        html = `<h3>âš ï¸ æš‚æœªæ”¶å½•è¯¥èµ„æº</h3>
                <p>å…³é”®è¯ï¼š<strong>${keyword}</strong></p>
                <p>è¯·å°è¯•ç²¾ç®€å…³é”®è¯ï¼Œæˆ–æ‰«ç åŠ å…¥èµ„æºç¾¤æ±‚èµ„æº</p>
                <button id="requestBtn" class="btn" style="background:#ff6b35;">ğŸ“® æ±‚èµ„æº</button>
                <img src="static/wechat_qrcode.png" style="width:350px;height:350px;">`;
    }

    modalBody.innerHTML = html;
    modal.style.display = 'flex';

    // æœªæ‰¾åˆ°èµ„æºæ—¶ç»‘å®šæ±‚èµ„æºæŒ‰é’®äº‹ä»¶
    if (!item) {
        document.getElementById('requestBtn').addEventListener('click', async function() {
            const btn = this;
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';
            
            try {
                const res = await fetch('/api/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword: keyword })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('âœ… ' + data.message);
                    modal.style.display = 'none';
                } else {
                    alert('âŒ ' + (data.error || 'æäº¤å¤±è´¥'));
                }
            } catch (e) {
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + e.message);
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ“® æ±‚èµ„æº';
        });
    }
}

// è¯Šæ–­400é”™è¯¯çš„å‡½æ•°
async function diagnose400Error(keyword, apiPath, response, data) {
    console.log('=== 400é”™è¯¯è¯Šæ–­ ===');

    // æµ‹è¯•1ï¼šç›´æ¥è®¿é—®å®Œæ•´URL
    const fullUrl = window.location.origin + apiPath;
    console.log('æµ‹è¯•å®Œæ•´URL:', fullUrl);

    try {
        const directTest = await fetch(fullUrl);
        const directText = await directTest.text();
        console.log('ç›´æ¥è®¿é—®ç»“æœ-çŠ¶æ€:', directTest.status);
        console.log('ç›´æ¥è®¿é—®ç»“æœ-å†…å®¹:', directText);
    } catch (e) {
        console.log('ç›´æ¥è®¿é—®é”™è¯¯:', e.message);
    }

    // æµ‹è¯•2ï¼šæµ‹è¯•ä¸åŒåŸŸå
    console.log('æµ‹è¯•ä¸åŒåŸŸå...');
    const domains = [
        window.location.origin,
        'https://quark-static.pages.dev'
    ];

    for (const domain of domains) {
        const testUrl = domain + '/api/record?q=' + encodeURIComponent(keyword);
        console.log(`æµ‹è¯• ${domain}:`, testUrl);

        try {
            const testRes = await fetch(testUrl);
            console.log(`  çŠ¶æ€: ${testRes.status}`);
        } catch (e) {
            console.log(`  é”™è¯¯: ${e.message}`);
        }
    }
}

// çƒ­æœå…³é”®è¯è¿‡æ»¤é…ç½®
const FILTER_KEYWORDS = [
    // åœ¨è¿™é‡Œæ·»åŠ éœ€è¦è¿‡æ»¤çš„å…³é”®è¯
    // ä¾‹å¦‚ï¼š'æ•æ„Ÿè¯', 'å¹¿å‘Š', 'ä¸éœ€è¦å±•ç¤ºçš„å…³é”®è¯'
    'å‰§æœ¬'
];

// åŠ è½½å…¨ç½‘çƒ­æœæ¦œ (ä» Pages API è·å–)
async function loadHotKeywords(retryCount = 0) {
    const container = document.getElementById('recommend');
    const maxRetries = 3;

    try {
        // 1ï¸âƒ£ ç­‰å¾… data.json åŠ è½½å®Œæˆï¼ˆæœ€å¤š 3 ç§’ï¼‰
        let retry = 0;
        while (localData.length === 0 && retry < 30) {
            await new Promise(r => setTimeout(r, 100));
            retry++;
        }

        if (localData.length === 0) {
            // data.json åŠ è½½å¤±è´¥ï¼Œå°è¯•é‡æ–°åŠ è½½
            if (retryCount < maxRetries) {
                await loadData();
                return loadHotKeywords(retryCount + 1);
            }
            container.innerHTML = '';
            return;
        }

        // 2ï¸âƒ£ è·å–çƒ­æœæ¦œï¼ˆå¸¦è¶…æ—¶ï¼‰
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        try {
            const res = await fetch('/api/hot', { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const hotList = await res.json();
            
            // 3ï¸âƒ£ è¿‡æ»¤çƒ­æœï¼šæ¬¡æ•° + èƒ½å‘½ä¸­èµ„æº + è¿‡æ»¤æŒ‡å®šå…³é”®è¯
            const validHotList = hotList.filter(item => {
                if (item.count < 10) return false;

                const word = String(item.word || '').trim();
                if (!word) return false;

                if (FILTER_KEYWORDS.includes(word)) return false;

                return localData.some(res =>
                    String(res.title || '').includes(word) ||
                    Array.isArray(res.keywords) &&
                    res.keywords.some(k => String(k).includes(word))
                );
            });

            if (!validHotList.length) {
                container.innerHTML = '';
                return;
            }

            // 4ï¸âƒ£ æ¸²æŸ“
            let html = `<div class="recommend-card"><h3>ğŸ”¥ å…¨ç½‘å®æ—¶çƒ­æœ</h3>`;

            validHotList.forEach(item => {
                const isFire = item.count >= 10 ? 'hot-fire' : '';
                const fireIcon = item.count >= 10 ? 'ğŸ”¥' : '';
                const safeWord = item.word.replace(/'/g, "\\'");

                html += `<span class="hot-keyword ${isFire}"
                    onclick="document.getElementById('searchInput').value='${safeWord}';
                             document.getElementById('searchBtn').click();">
                    ${fireIcon}${item.word}
                </span>`;
            });

            html += '</div>';
            container.innerHTML = html;

        } catch (fetchError) {
            clearTimeout(timeoutId);
            console.warn('çƒ­æœè¯·æ±‚å¤±è´¥:', fetchError);
            
            // é‡è¯•æœºåˆ¶
            if (retryCount < maxRetries) {
                await new Promise(r => setTimeout(r, 1000));
                return loadHotKeywords(retryCount + 1);
            }
            container.innerHTML = '';
        }

    } catch (err) {
        console.error('çƒ­æœåŠ è½½å¤±è´¥:', err);
        container.innerHTML = '';
    }
}

// äº‹ä»¶ç»‘å®š
searchBtn.addEventListener('click', () => performSearch(searchInput.value.trim()));
searchInput.addEventListener('keypress', e => { if(e.key==='Enter') searchBtn.click(); });

// é¡µé¢åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
    loadData();        // 1. é¢„åŠ è½½èµ„æºæ•°æ®
    loadHotKeywords(); // 2. åŠ è½½çƒ­æœæ¦œ

    // 3. æ£€æŸ¥ URL æ˜¯å¦å¸¦å‚æ•° (ä¾‹å¦‚ ?q=å‰§æœ¬æ€)
    const params = new URLSearchParams(location.search);
    const q = params.get('q');
    if(q){
        searchInput.value = q;
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
        setTimeout(() => performSearch(q), 200);
    }
});



</script>
    <!--<div id="page-container" style="min-height: 50vh;">
    </div>
    <div class="site-disclaimer">
    <h4>æ¸©é¦¨æç¤º</h4>
    <p>æ‚¨åœ¨æ­¤è·å–çš„èµ„æºæºäºç½‘ç»œåˆ†äº«ï¼Œæ—¨åœ¨æ–¹ä¾¿å­¦ä¹ äº¤æµã€‚è¯·å°Šé‡çŸ¥è¯†äº§æƒï¼Œåˆç†ä½¿ç”¨ï¼Œæ”¯æŒæ­£ç‰ˆã€‚è¯·å‹¿å°†èµ„æºç”¨äºå•†ä¸šæˆ–è¿è§„ç”¨é€”</p>
    <p>æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é…åˆï¼</p>
    </div>-->

    <!-- é¡µé¢åº•éƒ¨å…è´£å£°æ˜ -->
    <div class="site-disclaimer">
        <h4>æ¸©é¦¨æç¤º</h4>
        <p>æ‚¨åœ¨æ­¤è·å–çš„èµ„æºæºäºç½‘ç»œåˆ†äº«ï¼Œæ—¨åœ¨æ–¹ä¾¿å­¦ä¹ äº¤æµã€‚è¯·å°Šé‡çŸ¥è¯†äº§æƒï¼Œåˆç†ä½¿ç”¨ï¼Œæ”¯æŒæ­£ç‰ˆã€‚è¯·å‹¿å°†èµ„æºç”¨äºå•†ä¸šæˆ–è¿è§„ç”¨é€”</p>
        <p>æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é…åˆï¼</p>
    </div>
</body>
</html>
