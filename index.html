<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤¸å…‹ç½‘ç›˜èµ„æºæœç´¢ - å…è´¹é«˜é€Ÿä¸‹è½½</title>
<meta name="description" content="å…¨ç½‘å¤¸å…‹ç½‘ç›˜èµ„æºæœç´¢ï¼Œæ”¯æŒç”µè„‘/æ‰‹æœºç«¯ï¼Œæ¯æ—¥æ›´æ–°çƒ­æœæ¦œï¼Œç”µå½±ç”µè§†å‰§å­¦ä¹ èµ„æ–™å…è´¹ä¸‹ã€‚">
<style>
body { font-family: "Microsoft YaHei", Arial, sans-serif; background: #f5f5f5; display: flex; flex-direction: column; align-items: center; padding-top: 50px; margin:0; }

/* logo */
.logo { text-align: center; margin-bottom: 40px; flex-shrink: 0; }
.logo img { max-width: 150px; height: auto; display: block; margin: 0 auto; }
.logo h1 { margin-top: 10px; font-size: 28px; color: #333; }

/* æœç´¢æ¡† */
.search-container { display: flex; justify-content: center; margin-bottom: 20px; flex-wrap: nowrap; width: 90%; max-width: 480px; }
.search-container input[type="text"] { flex: 1; padding: 12px; font-size: 16px; border-radius: 5px 0 0 5px; border: 1px solid #ccc; outline: none; }
.search-container button { padding: 12px 24px; font-size: 16px; border-radius: 0 5px 5px 0; border: none; background-color: #1e90ff; color: white; cursor: pointer; transition: background 0.3s; }
.search-container button:hover { background-color: #0f78d1; }

.highlight { color: #e74c3c; font-weight: bold; }

/* æ¨èåŒº */
#recommend { width: 100%; max-width: 480px; margin-bottom: 20px; }
.recommend-card { display: flex; flex-wrap: wrap; gap: 10px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
.recommend-card h3 { width:100%; margin-top:0; margin-bottom:15px; font-size: 16px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 10px;}
.hot-keyword { padding: 6px 12px; background: #f0f6ff; border-radius: 20px; text-align: center; cursor: pointer; transition: all 0.2s; color: #1e90ff; font-size: 14px; }
.hot-keyword:hover { background:#1e90ff; color: #fff; transform: translateY(-2px); }
.hot-fire { color: #ff4500; background: #fff0f0; font-weight: bold; } /* çˆ†æ¬¾æ ·å¼ */

/* æ¨¡æ€æ¡† */
.modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
.modal-content { background-color: #fff; padding: 30px; border-radius: 12px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); position: relative; }
.close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; }
.modal-content img { margin-top: 15px; max-width: 100%; }
.btn { display: inline-block; margin-top: 20px; padding: 12px 35px; font-size: 16px; background-color: #1e90ff; color: #fff; text-decoration: none; border-radius: 25px; cursor:pointer; font-weight: bold; }
.btn:hover { background-color: #0f78d1; }

/* å“åº”å¼ */
@media (max-width: 480px){
    .search-container { flex-wrap: wrap; }
    .search-container input[type="text"] { flex: 1 1 100%; border-radius: 5px; margin-bottom: 8px; }
    .search-container button { flex: 1 1 100%; border-radius: 5px; }
}
</style>
</head>
<body>

<!-- logo -->
<div class="logo">
    <img src="static/logo.png" alt="å¤¸å…‹æœç´¢" onerror="this.style.display='none'">
    <h1>å¤¸å…‹ç½‘ç›˜èµ„æºæœç´¢</h1>
</div>

<!-- æœç´¢æ¡† -->
<div class="search-container">
    <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥ç”µå½±ã€ç”µè§†å‰§ã€èµ„æ–™...">
    <button id="searchBtn">æœç´¢</button>
</div>

<!-- é¦–é¡µæ¨èçƒ­æœ -->
<div id="recommend">
    <!-- é»˜è®¤åŠ è½½æ€ï¼ŒJSåŠ è½½å®Œæˆåä¼šè¦†ç›–è¿™é‡Œ -->
    <div class="recommend-card">
        <h3>ğŸ”¥ æ­£åœ¨åŠ è½½å®æ—¶çƒ­æœ...</h3>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>

<script>
// ============================================================
// ğŸ”„ ä¿®æ”¹ä¸ºä½¿ç”¨ Cloudflare Pages Functions API
// æ‰€æœ‰ API è°ƒç”¨ç°åœ¨éƒ½æŒ‡å‘åŒä¸€åŸŸåçš„ /api è·¯å¾„
// ============================================================

// DOM å…ƒç´ 
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const searchBtn = document.getElementById('searchBtn');
const searchInput = document.getElementById('searchInput');

// å…³é—­å¼¹çª—é€»è¾‘
modal.addEventListener('click', e => { if(e.target === modal) modal.style.display='none' });

// åŠ è½½æœ¬åœ°èµ„æºæ•°æ® (data.json ç”± Python è„šæœ¬ç”Ÿæˆ)
let localData = [];
async function loadData() {
    try {
        // Pages ç¯å¢ƒç›´æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„
        const res = await fetch(`data.json?t=${Date.now()}`);
        localData = await res.json();
    } catch {
        console.error("æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥");
        localData = [];
    }
}

// é«˜äº®å…³é”®è¯
function highlight(text, keyword) {
    if(!keyword) return text;
    const reg = new RegExp(`(${keyword})`,'gi');
    return text.replace(reg,'<span class="highlight">$1</span>');
}

// æ ¸å¿ƒæœç´¢åŠŸèƒ½
async function performSearch(keyword) {
    console.log('=== performSearch è°ƒè¯•ä¿¡æ¯ ===');
    console.log('å½“å‰åŸŸå:', window.location.hostname);
    console.log('é¡µé¢URL:', window.location.href);

    if (!keyword) return;

    // 1. ä¿®æ”¹ URL
    const newUrl = `?q=${encodeURIComponent(keyword)}`;
    window.history.pushState({path:newUrl}, '', newUrl);
    document.title = `${keyword} - å¤¸å…‹èµ„æºæœç´¢`;

    // 2. ä¸ŠæŠ¥ç»Ÿè®¡åˆ° Pages API
    console.log('=== å¼€å§‹ç»Ÿè®¡ä¸ŠæŠ¥ ===');

    try {
        // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œç¡®ä¿è°ƒç”¨æ­£ç¡®çš„åŸŸå
        const apiPath = `/api/record?q=${encodeURIComponent(keyword)}`;
        console.log('APIè·¯å¾„:', apiPath);

        const startTime = Date.now();
        const reportRes = await fetch(apiPath);
        const endTime = Date.now();

        console.log('è¯·æ±‚è€—æ—¶:', (endTime - startTime) + 'ms');
        console.log('HTTPçŠ¶æ€ç :', reportRes.status);
        console.log('çŠ¶æ€æ–‡æœ¬:', reportRes.statusText);
        console.log('å“åº”URL:', reportRes.url);

        // æ£€æŸ¥å“åº”å¤´
        console.log('å“åº”å¤´-CF-Ray:', reportRes.headers.get('cf-ray'));
        console.log('å“åº”å¤´-CF-Cache-Status:', reportRes.headers.get('cf-cache-status'));

        // è¯»å–å“åº”
        const responseText = await reportRes.text();
        console.log('å“åº”å†…å®¹:', responseText);

        // è§£æ JSON
        let reportData;
        try {
            reportData = JSON.parse(responseText);
            console.log('è§£ææˆåŠŸ:', reportData);
        } catch (parseError) {
            console.error('JSONè§£æå¤±è´¥:', parseError);
            reportData = {
                success: false,
                error: 'Invalid JSON',
                raw: responseText,
                status: reportRes.status
            };
        }

        // å¤„ç†ç»“æœ
        if (reportRes.ok && reportData.success) {
            console.log('âœ… ç»Ÿè®¡æˆåŠŸ');

            if (reportData.count >= 10) {
                console.log('ğŸ”¥ è¾¾åˆ°çƒ­æœé˜ˆå€¼');
                loadHotKeywords();
            }
        } else {
            console.error('âŒ ç»Ÿè®¡å¤±è´¥');
            console.error('å¤±è´¥è¯¦æƒ…:', reportData);

            // å¦‚æœæ˜¯400é”™è¯¯ï¼Œæ˜¾ç¤ºè¯¦ç»†è¯Šæ–­
            if (reportRes.status === 400) {
                await diagnose400Error(keyword, apiPath, reportRes, reportData);
            }
        }

    } catch (fetchError) {
        console.error('âŒ ç½‘ç»œè¯·æ±‚å¼‚å¸¸');
        console.error('é”™è¯¯ç±»å‹:', fetchError.name);
        console.error('é”™è¯¯ä¿¡æ¯:', fetchError.message);
        console.error('é”™è¯¯å †æ ˆ:', fetchError.stack);
    }

    console.log('=== ç»Ÿè®¡ä¸ŠæŠ¥ç»“æŸ ===');

    // 3. åœ¨æœ¬åœ°æ•°æ®ä¸­æŸ¥æ‰¾èµ„æº
    if (localData.length === 0) await loadData();

    // åŒ¹é…é€»è¾‘ï¼šæ ‡é¢˜åŒ…å« æˆ– å…³é”®è¯æ•°ç»„åŒ…å«
    const item = localData.find(d =>
        d.title.toLowerCase().includes(keyword.toLowerCase()) ||
        (d.keywords && d.keywords.some(k => k.toLowerCase().includes(keyword.toLowerCase())))
    );

    const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
    let html = '';

    if (item) {
        // æ‰¾åˆ°èµ„æº
        html = `<h3>âœ… æ‰¾åˆ°èµ„æºï¼š${highlight(item.title, keyword)}</h3>`;

        if (isMobile) {
            // æ‰‹æœºç«¯ï¼šæ˜¾ç¤ºè·³è½¬æŒ‰é’®
            html += `<p style="color:#666;margin:15px 0;">èµ„æºå·²å‡†å¤‡å¥½ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¿é—®èµ„æº</p>
                     <a href="${item.share_link}" target="_blank" class="btn">æ‰“å¼€å¤¸å…‹APPä¿å­˜</a>`;
        } else {
            // ç”µè„‘ç«¯ï¼šæ˜¾ç¤ºäºŒç»´ç 
            html += `<p style="color:#666;">è¯·ä½¿ç”¨å¤¸å…‹æˆ–å¾®ä¿¡æ‰«æä¸‹æ–¹äºŒç»´ç è®¿é—®èµ„æº</p>
                     <img src="${item.qrcode}" style="width:200px;height:200px;display:block;margin:10px auto;">`;
        }
    } else {
        // æœªæ‰¾åˆ°èµ„æº
        html = `<h3>âš ï¸ æš‚æœªæ”¶å½•è¯¥èµ„æº</h3>
                <p>å…³é”®è¯ï¼š<strong>${keyword}</strong></p>
                <p>è¯·å°è¯•ç²¾ç®€å…³é”®è¯ï¼Œæˆ–æ‰«ç åŠ å…¥èµ„æºç¾¤æ±‚èµ„æº</p>
                <img src="static/wechat_qrcode.png" style="width:350px;height:350px;">`;
    }

    modalBody.innerHTML = html;
    modal.style.display = 'flex';
}

// è¯Šæ–­400é”™è¯¯çš„å‡½æ•°
async function diagnose400Error(keyword, apiPath, response, data) {
    console.log('=== 400é”™è¯¯è¯Šæ–­ ===');

    // æµ‹è¯•1ï¼šç›´æ¥è®¿é—®å®Œæ•´URL
    const fullUrl = window.location.origin + apiPath;
    console.log('æµ‹è¯•å®Œæ•´URL:', fullUrl);

    try {
        const directTest = await fetch(fullUrl);
        const directText = await directTest.text();
        console.log('ç›´æ¥è®¿é—®ç»“æœ-çŠ¶æ€:', directTest.status);
        console.log('ç›´æ¥è®¿é—®ç»“æœ-å†…å®¹:', directText);
    } catch (e) {
        console.log('ç›´æ¥è®¿é—®é”™è¯¯:', e.message);
    }

    // æµ‹è¯•2ï¼šæµ‹è¯•ä¸åŒåŸŸå
    console.log('æµ‹è¯•ä¸åŒåŸŸå...');
    const domains = [
        window.location.origin,
        'https://quark-static.pages.dev'
    ];

    for (const domain of domains) {
        const testUrl = domain + '/api/record?q=' + encodeURIComponent(keyword);
        console.log(`æµ‹è¯• ${domain}:`, testUrl);

        try {
            const testRes = await fetch(testUrl);
            console.log(`  çŠ¶æ€: ${testRes.status}`);
        } catch (e) {
            console.log(`  é”™è¯¯: ${e.message}`);
        }
    }
}

// åŠ è½½å…¨ç½‘çƒ­æœæ¦œ (ä» Pages API è·å–)
async function loadHotKeywords() {
    try {
        const res = await fetch('/api/hot');

        if (!res.ok) {
            throw new Error(`API è¿”å›é”™è¯¯: ${res.status}`);
        }

        const hotList = await res.json();

        if (!hotList || hotList.length === 0) {
            // å¦‚æœæ²¡æœ‰çƒ­æœæ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤æç¤º
            document.getElementById('recommend').innerHTML = '<div class="recommend-card"><h3>ğŸ”¥ çƒ­é—¨èµ„æºæœç´¢</h3><span class="hot-keyword" onclick="document.getElementById(\'searchInput\').value=\'å‰§æœ¬æ€\';document.getElementById(\'searchBtn\').click();">å‰§æœ¬æ€</span></div>';
            return;
        }

        let html = `<div class="recommend-card"><h3>ğŸ”¥ å…¨ç½‘å®æ—¶çƒ­æœ</h3>`;
        hotList.forEach(item => {
            // æœç´¢æ¬¡æ•° >= 10 æ¬¡çš„æ ‡çº¢æ˜¾ç¤º
            const isFire = item.count >= 10 ? 'hot-fire' : '';
            const fireIcon = item.count >= 10 ? 'ğŸ”¥' : '';

            // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œé¿å… XSS
            const safeWord = item.word.replace(/'/g, "\\'");

            html += `<span class="hot-keyword ${isFire}"
                        onclick="document.getElementById('searchInput').value='${safeWord}'; document.getElementById('searchBtn').click();">
                        ${fireIcon}${item.word}
                     </span>`;
        });
        html += '</div>';
        document.getElementById('recommend').innerHTML = html;

    } catch (e) {
        console.warn("çƒ­æœåŠ è½½å¤±è´¥:", e);
        // å¤±è´¥æ—¶æ˜¾ç¤ºé™æ€æ¨è
        //document.getElementById('recommend').innerHTML = '<div class="recommend-card"><h3>ğŸ”¥ çƒ­é—¨èµ„æºæœç´¢</h3><span class="hot-keyword" onclick="document.getElementById(\'searchInput\').value=\'å‰§æœ¬æ€\';document.getElementById(\'searchBtn\').click();">å‰§æœ¬æ€</span><span class="hot-keyword" onclick="document.getElementById(\'searchInput\').value=\'è€ƒç ”èµ„æ–™\';document.getElementById(\'searchBtn\').click();">è€ƒç ”èµ„æ–™</span><span class="hot-keyword" onclick="document.getElementById(\'searchInput\').value=\'ç”µå½±\';document.getElementById(\'searchBtn\').click();">ç”µå½±</span></div>';

        document.getElementById('recommend').innerHTML = '<div class="recommend-card"><h3>ğŸ”¥ çƒ­é—¨èµ„æºæœç´¢</h3><span class="hot-keyword" onclick="document.getElementById(\'searchInput\').value=\'å‰§æœ¬æ€\';document.getElementById(\'searchBtn\').click();">å‰§æœ¬æ€</span></div>';
    }
}

// äº‹ä»¶ç»‘å®š
searchBtn.addEventListener('click', () => performSearch(searchInput.value.trim()));
searchInput.addEventListener('keypress', e => { if(e.key==='Enter') searchBtn.click(); });

// é¡µé¢åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
    loadData();        // 1. é¢„åŠ è½½èµ„æºæ•°æ®
    loadHotKeywords(); // 2. åŠ è½½çƒ­æœæ¦œ

    // 3. æ£€æŸ¥ URL æ˜¯å¦å¸¦å‚æ•° (ä¾‹å¦‚ ?q=å‰§æœ¬æ€)
    const params = new URLSearchParams(location.search);
    const q = params.get('q');
    if(q){
        searchInput.value = q;
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
        setTimeout(() => performSearch(q), 200);
    }
});
</script>
</body>
</html>
